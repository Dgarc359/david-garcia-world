"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6888],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>d});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},u=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=p(t),d=r,h=m["".concat(l,".").concat(d)]||m[d]||c[d]||s;return t?a.createElement(h,i(i({ref:n},u),{},{components:t})):a.createElement(h,i({ref:n},u))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,i=new Array(s);i[0]=m;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<s;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},8031:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var a=t(7462),r=(t(7294),t(3905));const s={},i=void 0,o={unversionedId:"General/AWS/Lambdas/Extensions/extensions",id:"General/AWS/Lambdas/Extensions/extensions",title:"extensions",description:"Internal vs. External Extensions",source:"@site/docs/General/AWS/Lambdas/Extensions/extensions.md",sourceDirName:"General/AWS/Lambdas/Extensions",slug:"/General/AWS/Lambdas/Extensions/",permalink:"/book/index.html/docs/General/AWS/Lambdas/Extensions/",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/General/AWS/Lambdas/Extensions/extensions.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"lambdas",permalink:"/book/index.html/docs/General/AWS/Lambdas/"},next:{title:"neptune",permalink:"/book/index.html/docs/General/AWS/Neptune/"}},l={},p=[{value:"Internal vs. External Extensions",id:"internal-vs-external-extensions",level:4},{value:"Lambda Execution env with Extensions API",id:"lambda-execution-env-with-extensions-api",level:2},{value:"New Lambda Lifecycle with Extensions",id:"new-lambda-lifecycle-with-extensions",level:5},{value:"Modifying Lambda runtime with extensions",id:"modifying-lambda-runtime-with-extensions",level:2},{value:"How are extensions delivered and run?",id:"how-are-extensions-delivered-and-run",level:2},{value:"Real-World Extension use-cases",id:"real-world-extension-use-cases",level:2}],u={toc:p};function c(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h4",{id:"internal-vs-external-extensions"},"Internal vs. External Extensions"),(0,r.kt)("p",null,"Internal - Internal extensions run as part of the runtime process, in-process with your code. They allow you to modify the startup of the runtime process using language-specific environment variables and wrapper scripts. Internal extensions enable use cases such as automatically instrumenting code."),(0,r.kt)("p",null,"External - External extensions allow you to run separate processes from the runtime but still within the same execution environment as the Lambda function. External extensions can start before the runtime process, and can continue after the runtime shuts down. External extensions enable use cases such as fetching secrets before the invocation, or sending telemetry to a custom destination outside of the function invocation. These extensions run as companion processes to Lambda functions."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"lambda-execution-env-with-extensions-api"},"Lambda Execution env with Extensions API"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2020/10/07/1-AWS-Lambda-execution-environment-with-the-Extensions-API.png",alt:"Lambda exec env with Extensions API"})),(0,r.kt)("p",null," Extensions are initialized before the runtime and the function. They then continue to run in parallel with the function, get greater control during function invocation, and can run logic during shut down."),(0,r.kt)("p",null,"^84e23a"),(0,r.kt)("h5",{id:"new-lambda-lifecycle-with-extensions"},"New Lambda Lifecycle with Extensions"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2020/10/08/3-New-Lambda-lifecycle-with-extensions.png",alt:"lambda lifecycle with extensions"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Updated init")," - ","[extension init, runtime init, function init]"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Control during invoke")," - Extensions may request lifecycle events from lambda service, run logic in response to lifecycle events, and respond to the --\x3elambda service<--(add ref here) when they are done. Since lambda freezes env when it hears back from runtime and all extensions, extensions can influence freeze / thaw behavior"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Shutdown Phase")," - Phase exposed to allow extensions to stop cleanly when exec env shuts down. Shut down event is sent by lambda service to runtime and extensions.")),(0,r.kt)("p",null,"Upon completion, runtime and all registered extensions request the ",(0,r.kt)("em",{parentName:"p"},"Next")," invocation event from Runtime(add ref) and Extensions API. Lambda freezes exec env and all extensions when there are no pending events"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://d2908q01vomqb2.cloudfront.net/1b6453892473a467d07372d45eb05abc2031647a/2020/10/08/4a-Lambda-lifecycle-for-execution-environment-runtime-extensions-and-function.png.png",alt:"Lifecycle for exec env, runtime, extensions, and function"})),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"modifying-lambda-runtime-with-extensions"},"Modifying Lambda runtime with extensions"),(0,r.kt)("p",null,"Internal extensions are necessary to modify the runtime process. These extensions are not separate processes, they run as part of the runtime process."),(0,r.kt)("p",null,"With runtime modification, we can access language specific environmental variables, that you can add options and tools to the runtime with. "),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/lambda/latest/dg/runtimes-modify.html#runtime-wrapper"},"wrapper scripts")," <--Add backlink\nCan be used to delegate the runtime startup to your own scripts. "),(0,r.kt)("p",null,"We can intercept lambda invokes and add shutdown hooks."),(0,r.kt)("p",null,"By setting a language specific env var, we can invoke our extension and modify our lambda runtime."),(0,r.kt)("p",null,"supported lambda runtimes for wrapper scripts:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Node.js 14.x"),(0,r.kt)("li",{parentName:"ul"},"Node.js 12.x"),(0,r.kt)("li",{parentName:"ul"},"Node.js 10.x"),(0,r.kt)("li",{parentName:"ul"},"Python 3.9"),(0,r.kt)("li",{parentName:"ul"},"Python 3.8"),(0,r.kt)("li",{parentName:"ul"},"Ruby 2.7"),(0,r.kt)("li",{parentName:"ul"},"Java 11"),(0,r.kt)("li",{parentName:"ul"},"Java 8 (",(0,r.kt)("inlineCode",{parentName:"li"},"java8.al2"),")"),(0,r.kt)("li",{parentName:"ul"},".NET Core 3.1")),(0,r.kt)("p",null,"Lambda starts runtime using your wrapper script. Lambda sends to your script:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"- Path to the interpreter\n- Optional args for standard runtime startup\n")),(0,r.kt)("p",null,"Wrapper script can:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"- Extend or transform startup behavior of the program\n    - ex: script can inject / alter args, set env vars, capture metrics, errors, and other diagnostic info\n")),(0,r.kt)("p",null,"How to add a wrapper script:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"- Set the value of `AWS_LAMBDA_EXEC_WRAPPER` env var as the file system path of an executable binary or script\n")),(0,r.kt)("p",null,"AWS Example: Create and use a wrapper script with python 3.8"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'  #!/bin/bash\n\n  # the path to the interpreter and all of the originally intended arguments\n  args=("$@")\n\n  # the extra options to pass to the interpreter\n  extra_args=("-X" "importtime")\n\n  # insert the extra options\n  args=("${args[@]:0:$#-1}" "${extra_args[@]}" "${args[@]: -1}")\n\n  # start the runtime with the extra options\n  exec "${args[@]}"       \n')),(0,r.kt)("p",null,"Notes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"- This is a bash wrapper script that is being wrapped around a python lambda function\n- args is the variable which holds the arguments originally intended for the lambda\n- The re-declaration of args injects extra args\n- exec starts the runtime with the extra args\n")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=WrpkMuVN6_I"},"Custom Runtimes on AWS Lambda: My experience doing Serverless PHP by Ben Ellerby")),(0,r.kt)("p",null,"![","[Pasted image 20211101134934.png]","]\nBootstrap file responsibilities"),(0,r.kt)("p",null,"![","[Pasted image 20211101135112.png]","]"),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"how-are-extensions-delivered-and-run"},"How are extensions delivered and run?"),(0,r.kt)("p",null,"Answer: Lambda Layers (add ref), or include them in the image for functions deployed as container images"),(0,r.kt)("p",null,"IMPORTANT NOTE:\nAs the function code directory is read-only, extensions cannot modify function code."),(0,r.kt)("p",null,"Extensions run in the same exec env which means they sahre env vars and permissions"),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"real-world-extension-use-cases"},"Real-World Extension use-cases"),(0,r.kt)("p",null,"In their [","[extensions-references#^787ca5|article]","], lumigo IO references how they are leveraging extensions to provide a real-world solution to monitoring for their customers. What does this extension entail?"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"- Real time CPU and Network usage monitoring\n")),(0,r.kt)("p",null,"They also mention the ",(0,r.kt)("a",{parentName:"p",href:"https://www.envoyproxy.io/"},"envoy proxy")," framework which seems to be useful for analyzing network traffic."),(0,r.kt)("hr",null),(0,r.kt)("p",null,"References"),"Switch to backlinks",(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html"},"Lambda Runtime Extensions API Docs"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/"},"Building Extensions for Lambdas Preview"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/aws-samples/aws-lambda-extensions/"},"AWS Lambda Extensions Samples Repository"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/aws-samples/aws-lambda-extensions/tree/main/custom-runtime-extension-demo"},"AWS Custom Runtime Extension Demo"),"\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/aws-samples/aws-lambda-extensions/tree/main/nodejs-example-extension"},"Example Extension in Node JS"),"\n^53fdb6\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/aws-samples/aws-lambda-extensions/tree/d240b9d9658b2f5fec7ca96fbb2bb773f0221c9e/nodejs-example-extension"},"NodeJS example extension")),(0,r.kt)("hr",null),(0,r.kt)("a",{href:"https://lumigo.io/blog/aws-lambda-extensions-what-are-they-and-why-do-they-matter/"},"Lumigo io | What are Lambda extensions and why do they matter"),(0,r.kt)("p",null,"^787ca5"))}c.isMDXComponent=!0}}]);